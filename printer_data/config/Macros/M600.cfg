[gcode_macro M600]
description: Cambio de filamento con confirmación, beep y opciones de purga

gcode:
    M117 Retirando filamento...

    # Mover el cabezal a la posición segura (tanto si hay impresión como si no)
    G91                     ; Modo de movimiento relativo
    G1 Z10 F300             ; Subir el cabezal 10mm para evitar raspar la pieza
    G90                     ; Volver a modo de movimiento absoluto
    G1 X0 Y213 Z160 F6000   ; Mover el cabezal a la posición segura (X=0, Y=213, Z=160)

    # Retraer el filamento
    G1 E-20 F300            ; Retraer 20mm de filamento
    M300 S1000 P500         ; Beep para indicar que el filamento fue retirado

    # Esperar a que cambies el filamento y confirmar en la pantalla LCD
    M117 Cambie el filamento y confirme en la pantalla LCD
    RESPOND MSG="Seleccione CONFIRMAR desde la pantalla LCD para continuar"  ; Mensaje en la pantalla LCD
    PAUSE                   ; Pausa para permitir que cambies el filamento manualmente y confirmes

    # Extruir filamento nuevo
    G1 E50 F300             ; Extruir 50mm de filamento nuevo

    # Si hay impresión en curso, preguntar en la LCD si extruir más o continuar
    {% if printer.extruder.can_resume %}
        M117 ¿Quiere extruir más o continuar impresión?
#        RESPOND MSG="Escriba: EXTRUIR o CONTINUAR"  ; Pregunta en la interfaz gráfica
        RESPOND MSG="Seleccione EXTRUIR o CONTINUAR desde la pantalla LCD"  ; Opción en la pantalla LCD
        PAUSE
        {% if printer.gcode.response=="EXTRUIR" %}
            G1 E50 F300     ; Extruir 50mm más
        {% endif %}
        RESUME              ; Reanudar la impresión después de la confirmación
    {% else %}
        # Si no hay impresión, preguntar si purgar o terminar
#        RESPOND MSG="¿Quiere purgar o terminar? Escriba: PURGAR o TERMINAR"  ; Pregunta en la interfaz gráfica
        RESPOND MSG="Seleccione PURGAR o TERMINAR desde la pantalla LCD"  ; Opción en la pantalla LCD
        PAUSE
        {% if printer.gcode.response=="PURGAR" %}
            G1 E50 F300     ; Extruir 50mm de filamento nuevo
        {% endif %}
        G28                 ; Ir a HOME si elige terminar o si termina el purgado
    {% endif %}

