[gcode_macro M600]
description: Cambio de filamento con movimiento y confirmación
gcode:
    {% set X_SAFE = 0 %}          # Posición segura en X
    {% set Y_SAFE = 210 %}         # Posición segura en Y (atrás a la izquierda)
    {% set Z_SAFE = 160 %}         # Altura segura
    {% set FILAMENT_RETRACT = 400 %}  # Retracción del filamento en mm
    {% set FILAMENT_LOAD = 20 %}   # Filamento a cargar antes de reanudar en mm

    # Pausar la impresión
    PAUSE

    # Mover a la posición segura (atrás a la izquierda) y levantar el cabezal a Z_SAFE
    G90                       ; Asegurarse de que estamos en modo absoluto
    G1 Z{Z_SAFE} F3000        ; Subir el cabezal a la posición absoluta Z=160
    G1 X{X_SAFE} Y{Y_SAFE} F9000  ; Mover a la posición segura (X=10, Y=250)

    # Retraer el filamento
    G1 E-{FILAMENT_RETRACT} F1000  ; Retraer 400mm de filamento

    # Emitir alerta sonora
    M300 S1000 P500          ; Sonido de alerta (beep)

    # Esperar a que el usuario cargue el nuevo filamento
    RESPOND MSG="Cambia el filamento y confirma en la interfaz para continuar."

    # Esperar confirmación manual
    WAIT_FOR_BUTTON

    # Cargar nuevo filamento
    G1 E{FILAMENT_LOAD} F1000   ; Cargar 20mm de filamento

    # Mover el cabezal de regreso a la posición original y reanudar la impresión
    RESUME
